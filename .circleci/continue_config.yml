version: 2.1

orbs:
  gcp-cli: circleci/gcp-cli@3.3.0
  circleci-utils: ethereum-optimism/circleci-utils@1.0.20

parameters:
  run-build-op-conductor-mon:
    type: boolean
    default: false
  run-build-op-conductor-ops:
    type: boolean
    default: false
  run-build-op-signer:
    type: boolean
    default: false
  run-build-op-txproxy:
    type: boolean
    default: false
  run-build-pms:
    type: boolean
    default: false
  run-build-op-ufm:
    type: boolean
    default: false
  run-build-proxyd:
    type: boolean
    default: false
  run-build-cci-stats:
    type: boolean
    default: false
  run-build-op-acceptor:
    type: boolean
    default: false
  run-build-rhc:
    type: boolean
    default: false
  run-all:
    type: boolean
    default: false
  vm-image:
    type: string
    default: ubuntu-2204:current

commands:
  gcp-oidc-authenticate:
    description: "Authenticate with GCP using a CircleCI OIDC token."
    parameters:
      project_id:
        type: env_var_name
        default: GCP_PROJECT_ID
      workload_identity_pool_id:
        type: env_var_name
        default: GCP_WIP_ID
      workload_identity_pool_provider_id:
        type: env_var_name
        default: GCP_WIP_PROVIDER_ID
      service_account_email:
        type: env_var_name
        default: GCP_SERVICE_ACCOUNT_EMAIL
      gcp_cred_config_file_path:
        type: string
        default: /home/circleci/gcp_cred_config.json
      oidc_token_file_path:
        type: string
        default: /home/circleci/oidc_token.json
    steps:
      - run:
          name: "Create OIDC credential configuration"
          command: |
            # Store OIDC token in temp file
            echo $CIRCLE_OIDC_TOKEN > << parameters.oidc_token_file_path >>
            # Create a credential configuration for the generated OIDC ID Token
            gcloud iam workload-identity-pools create-cred-config \
                "projects/${<< parameters.project_id >>}/locations/global/workloadIdentityPools/${<< parameters.workload_identity_pool_id >>}/providers/${<< parameters.workload_identity_pool_provider_id >>}"\
                --output-file="<< parameters.gcp_cred_config_file_path >>" \
                --service-account="${<< parameters.service_account_email >>}" \
                --credential-source-file=<< parameters.oidc_token_file_path >>
      - run:
          name: "Authenticate with GCP using OIDC"
          command: |
            # Configure gcloud to leverage the generated credential configuration
            gcloud auth login --brief --cred-file "<< parameters.gcp_cred_config_file_path >>"
            # Configure ADC
            echo "export GOOGLE_APPLICATION_CREDENTIALS='<< parameters.gcp_cred_config_file_path >>'" | tee -a "$BASH_ENV"

jobs:
  log-config-results:
    docker:
      - image: us-docker.pkg.dev/oplabs-tools-artifacts/images/ci-builder:latest # only used to enable codecov.
    environment:
      CURRENT_TAG: << pipeline.git.tag >>
    steps:
      - checkout:
          method: blobless
      - run:
          name: Log Configuration Results
          command: |
            echo "Configuration Results:"
            echo "run-build-op-conductor-mon: << pipeline.parameters.run-build-op-conductor-mon >>"
            echo "run-build-op-conductor-ops: << pipeline.parameters.run-build-op-conductor-ops >>"
            echo "run-build-op-signer: << pipeline.parameters.run-build-op-signer >>"
            echo "run-build-op-txproxy: << pipeline.parameters.run-build-op-txproxy >>"
            echo "run-build-pms: << pipeline.parameters.run-build-pms >>"
            echo "run-build-op-ufm: << pipeline.parameters.run-build-op-ufm >>"
            echo "run-build-proxyd: << pipeline.parameters.run-build-proxyd >>"
            echo "run-build-op-acceptor: << pipeline.parameters.run-build-op-acceptor >>"
            echo "run-build-rhc: << pipeline.parameters.run-build-rhc >>"
            echo "run-all: << pipeline.parameters.run-all >>"
            echo ""
            echo "Pipeline Trigger Information:"
            echo "pipeline.trigger_source: << pipeline.trigger_source >>"
            echo "Is not a scheduled pipeline: $([ "<< pipeline.trigger_source >>" != "scheduled_pipeline" ] && echo "true" || echo "false")"
            echo ""
            echo "Tag Information:"
            echo "Current tag: $CURRENT_TAG"

            # Use the same regex patterns as defined in the YAML anchors
            if [[ $CURRENT_TAG =~ ^proxyd/v.* ]]; then
              echo "proxyd tag regex match: true"
            else
              echo "proxyd tag regex match: false"
            fi

            if [[ $CURRENT_TAG =~ ^op-conductor-mon/v.* ]]; then
              echo "op-conductor-mon tag regex match: true"
            else
              echo "op-conductor-mon tag regex match: false"
            fi

            if [[ $CURRENT_TAG =~ ^op-conductor-ops/v.* ]]; then
              echo "op-conductor-ops tag regex match: true"
            else
              echo "op-conductor-ops tag regex match: false"
            fi

            if [[ $CURRENT_TAG =~ ^op-signer/v.* ]]; then
              echo "op-signer tag regex match: true"
            else
              echo "op-signer tag regex match: false"
            fi

            if [[ $CURRENT_TAG =~ ^op-txproxy/v.* ]]; then
              echo "op-txproxy tag regex match: true"
            else
              echo "op-txproxy tag regex match: false"
            fi

            if [[ $CURRENT_TAG =~ ^peer-mgmt-service/v.* ]]; then
              echo "peer-mgmt-service tag regex match: true"
            else
              echo "peer-mgmt-service tag regex match: false"
            fi

            if [[ $CURRENT_TAG =~ ^op-ufm/v.* ]]; then
              echo "op-ufm tag regex match: true"
            else
              echo "op-ufm tag regex match: false"
            fi

            if [[ $CURRENT_TAG =~ ^op-acceptor/v.* ]]; then
              echo "op-acceptor tag regex match: true"
            else
              echo "op-acceptor tag regex match: false"
            fi

            if [[ $CURRENT_TAG =~ ^replica-healthcheck/v.* ]]; then
              echo "replica-healthcheck tag regex match: true"
            else
              echo "replica-healthcheck tag regex match: false"
            fi

  go-lint:
    parameters:
      module:
        description: Go Module Name
        type: string
    docker:
      - image: cimg/go:1.23
        user: root
    steps:
      - circleci-utils/checkout-with-mise
      - run:
          name: run generate
          command: |
            make generate || go generate ./...
          working_directory: <<parameters.module>>
      - run:
          name: run tidy
          command: |
            go mod tidy && git diff --exit-code
          working_directory: <<parameters.module>>
      - run:
          name: run lint
          command: |
            if [ "<<parameters.module>>" = "op-acceptor" ]; then
              make lint
            else
              # Original lint command for other projects
              if [ -f .golangci.yml ]; then
               golangci-lint run -c .golangci.yml -E goimports,sqlclosecheck,bodyclose,asciicheck,misspell,errorlint -e "errors.As" -e "errors.Is" --timeout "5m0s" ./...
              else
               golangci-lint run -E goimports,sqlclosecheck,bodyclose,asciicheck,misspell,errorlint -e "errors.As" -e "errors.Is" --timeout "5m0s" ./...
              fi
            fi
          working_directory: <<parameters.module>>

  go-test:
    parameters:
      module:
        description: Go Module Name
        type: string
    docker:
      - image: cimg/go:1.23
        user: root
      - image: cimg/postgres:14.6
        environment:
          POSTGRES_USER: opc
          POSTGRES_HOST_AUTH_METHOD: trust
    resource_class: medium
    steps:
      - run:
          name: Install codecov
          command: |
            # Install codecov CLI (previously provided by ci-builder image)
            if ! command -v codecov &> /dev/null; then
              curl -Os https://uploader.codecov.io/latest/linux/codecov
              chmod +x codecov
              sudo mv codecov /usr/local/bin/
            fi
      - circleci-utils/checkout-with-mise
      - run:
          name: go version
          command: go version
      - run:
          name: prep results dir
          command: mkdir -p /tmp/test-results
      - run:
          name: run generate
          command: |
            make generate || go generate ./...
          working_directory: <<parameters.module>>
      - run:
          name: run tests
          command: |
            # Use gotestsum with junit output for CircleCI
            gotestsum --format=standard-verbose --junitfile=/tmp/test-results/<<parameters.module>>.xml \
            -- -ldflags="-checklinkname=0" -coverpkg=github.com/ethereum-optimism/infra/... -coverprofile=coverage.out ./...
          working_directory: <<parameters.module>>
      - run:
          name: upload coverage
          command: codecov --verbose --clean --flags <<parameters.module>>
      - store_test_results:
          path: /tmp/test-results

  # TODO: this should be in an orb to improve reusability.
  go-release:
    parameters:
      module:
        description: Go Module Name
        type: string
      filename:
        description: Goreleaser config file
        default: .goreleaser.yaml
        type: string
    docker:
      - image: us-docker.pkg.dev/oplabs-tools-artifacts/images/ci-builder:latest
    resource_class: large
    steps:
      - setup_remote_docker
      - gcp-cli/install
      - gcp-oidc-authenticate:
          gcp_cred_config_file_path: /root/gcp_cred_config.json
          oidc_token_file_path: /root/oidc_token.json
      - checkout:
          method: blobless
      - run:
          name: Setup mise
          command: |
            # Install mise
            curl -fsSL https://mise.run | sh
            echo 'eval "$($HOME/.local/bin/mise activate bash)"' >> $BASH_ENV
            source $BASH_ENV
            # Install tools from mise.toml
            mise install --verbose
      - run:
          name: Configure Docker
          command: |
            gcloud auth configure-docker us-docker.pkg.dev
      - run:
          name: Run goreleaser
          command: |
            goreleaser release --clean -f ./<<parameters.module>>/<<parameters.filename>>

  # Run full op-acceptor suite, including acceptance tests via make test-all
  op-acceptor-test-all:
    docker:
      - image: cimg/go:1.23
        user: root
    resource_class: medium
    steps:
      - circleci-utils/checkout-with-mise
      - run:
          name: go version
          command: go version
      - run:
          name: run test-all
          command: make test-all
          working_directory: op-acceptor
      - store_artifacts:
          path: op-acceptor/logs
          destination: op-acceptor-logs

  op-conductor-ops-lint:
    docker:
      - image: cimg/python:3.12
    steps:
      - checkout: # Checks out code to ~/project
          method: blobless
      - restore_cache:
          keys:
            # Checksum relative to the root of the project
            - v1-poetry-{{ checksum "op-conductor-ops/poetry.lock" }}
            - v1-poetry-
      - run:
          name: Install Poetry & Dependencies
          # Run commands within the specific module directory
          working_directory: op-conductor-ops
          command: |
            pip install poetry
            # Check if pyproject.toml exists before running poetry commands
            if [ -f pyproject.toml ]; then
              poetry check --lock
              poetry install --no-interaction --no-root
            else
              echo "pyproject.toml not found in op-conductor-ops, skipping dependency installation."
            fi
      - save_cache:
          key: v1-poetry-{{ checksum "op-conductor-ops/poetry.lock" }}
          paths:
            - /home/circleci/.cache/pypoetry # Default cache location in cimg images
      - run:
          name: Run Black Linter
          # Run commands within the specific module directory
          working_directory: op-conductor-ops
          command: |
            # Check if pyproject.toml exists and black is installed (implicitly via poetry install)
            if [ -f pyproject.toml ]; then
              # Check if black is available
              if poetry run black --version > /dev/null 2>&1; then
                poetry run black --check .
              else
                echo "Black not found in project dependencies, skipping lint."
              fi
            else
              echo "pyproject.toml not found in op-conductor-ops, skipping lint."
            fi

workflows:
  logging:
    jobs:
      - log-config-results:
          filters:
            tags:
              only: /.*/
            branches:
              ignore: /.*/
  op-conductor-mon:
    when:
      or: [<< pipeline.parameters.run-build-op-conductor-mon >>, << pipeline.parameters.run-all >>]
    jobs:
      - go-lint:
          name: op-conductor-mon-lint
          module: op-conductor-mon
      - go-test:
          name: op-conductor-mon-tests
          module: op-conductor-mon
  op-conductor-ops:
    when:
      or: [<< pipeline.parameters.run-build-op-conductor-ops >>, << pipeline.parameters.run-all >>]
    jobs:
      - op-conductor-ops-lint
  op-signer:
    when:
      or: [<< pipeline.parameters.run-build-op-signer >>, << pipeline.parameters.run-all >>]
    jobs:
      - go-lint:
          name: op-signer-lint
          module: op-signer
      - go-test:
          name: op-signer-tests
          module: op-signer
  peer-mgmt-service:
    when:
      or: [<< pipeline.parameters.run-build-pms >>, << pipeline.parameters.run-all >>]
    jobs:
      - go-lint:
          name: pms-lint
          module: peer-mgmt-service
      - go-test:
          name: pms-tests
          module: peer-mgmt-service
  op-txproxy:
    when:
      or: [<< pipeline.parameters.run-build-op-txproxy >>, << pipeline.parameters.run-all >>]
    jobs:
      - go-lint:
          name: op-txproxy-lint
          module: op-txproxy
      - go-test:
          name: op-txproxy-tests
          module: op-txproxy
  op-ufm:
    when:
      or: [<< pipeline.parameters.run-build-op-ufm >>, << pipeline.parameters.run-all >>]
    jobs:
      - go-lint:
          name: op-ufm-lint
          module: op-ufm
      - go-test:
          name: op-ufm-tests
          module: op-ufm
  op-proxyd:
    when:
      or: [<< pipeline.parameters.run-build-proxyd >>, << pipeline.parameters.run-all >>]
    jobs:
      - go-lint:
          name: proxyd-lint
          module: proxyd
      - go-test:
          name: proxyd-tests
          module: proxyd
  cci-stats:
    when:
      or: [ << pipeline.parameters.run-build-cci-stats >>, << pipeline.parameters.run-all >> ]
    jobs:
      - go-lint:
          name: cci-stats-lint
          module: cci-stats
      - go-test:
          name: cci-stats-tests
          module: cci-stats
  op-acceptor:
    when:
      or: [<< pipeline.parameters.run-build-op-acceptor >>, << pipeline.parameters.run-all >>]
    jobs:
      - go-lint:
          name: op-acceptor-lint
          module: op-acceptor
      - go-test:
          name: op-acceptor-tests
          module: op-acceptor
      - op-acceptor-test-all

  release:
    jobs:
      - log-config-results:
          filters:
            tags:
              only: /^(replica-healthcheck|cci-stats|peer-mgmt-service|proxyd|ufm-[a-z0-9\-]*|op-[a-z0-9\-]*)\/v.*/
            branches:
              ignore: /.*/
      - hold:
          type: approval
          filters:
            tags:
              only: /^(replica-healthcheck|cci-stats|peer-mgmt-service|proxyd|ufm-[a-z0-9\-]*|op-[a-z0-9\-]*)\/v.*/
            branches:
              ignore: /.*/
      - go-release:
          matrix:
            parameters:
              module:
                - op-signer
                - op-txproxy
                - op-ufm
                - proxyd
                - op-conductor-mon
                - peer-mgmt-service
                - cci-stats
                - op-acceptor
          name: <<matrix.module>>-go-release
          filters:
            tags:
              only: /^<<matrix.module>>.*/
            branches:
              ignore: /.*/
          module: <<matrix.module>>
          context:
            - oplabs-gcr-release
